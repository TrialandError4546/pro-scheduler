<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Category, Multi-Week Pro Staff Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }

        /* Modal specific styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.7); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content {
            background-color: #1f2937; /* Gray-800 */
            margin: auto;
            padding: 20px;
            border-radius: 0.75rem; /* rounded-xl */
            width: 90%;
            max-width: 800px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            color: #e5e7eb; /* text-gray-200 */
            max-height: 90vh;
            overflow-y: auto;
        }
        .close-button {
            color: #9ca3af; /* gray-400 */
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: #f3f4f6; /* gray-100 */
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6 md:p-12">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-4xl font-bold mb-4 text-emerald-400">Multi-Category, Multi-Week Pro Staff Scheduler</h1>
        <p class="text-gray-400 mb-8">
            This is a live, collaborative scheduler. Assignments will be saved in real-time.
            <br/>
            <span class="font-semibold text-white">Your User ID: <span id="userId">Loading...</span></span>
        </p>

        <!-- Category Tabs (Daytime, Evenings, Weekends) -->
        <div id="category-tabs" class="flex flex-wrap gap-2 mb-4 border-b-2 border-gray-600">
            <!-- Category tabs will be injected by JavaScript -->
        </div>

        <!-- Day Tabs (Monday, Tuesday, etc.) -->
        <div id="day-tabs" class="flex flex-wrap gap-2 mb-8 border-b-2 border-gray-700">
            <!-- Day tabs will be injected by JavaScript -->
        </div>

        <!-- Week Navigation -->
        <div class="flex justify-between items-center mb-8">
            <button id="prevWeekBtn" class="px-4 py-2 bg-gray-700 text-white rounded-lg shadow-md hover:bg-gray-600 transition-colors duration-300">
                &larr; Previous Week
            </button>
            <span id="currentWeekDisplay" class="text-xl font-bold text-emerald-300">Loading Week...</span>
            <button id="nextWeekBtn" class="px-4 py-2 bg-gray-700 text-white rounded-lg shadow-md hover:bg-gray-600 transition-colors duration-300">
                Next Week &rarr;
            </button>
        </div>

        <!-- Today's Schedule Button -->
        <div class="mb-8">
            <button id="showTodayBtn" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300">
                Show Today's Schedule
            </button>
        </div>

        <div id="schedule-container" class="space-y-6">
            <!-- Class cards will be injected here by JavaScript -->
            <div id="loading" class="text-center text-lg text-gray-300">Loading schedule...</div>
        </div>
    </div>

    <!-- Email Content Modal -->
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="text-3xl font-bold mb-4 text-emerald-400">Today's Schedule Summary</h2>
            <p class="text-gray-400 mb-6">
                Below is a summary of today's assigned classes. You can copy the email content for each pro.
                <br>
                <span class="font-bold text-red-400">Note: This application does NOT send emails directly.</span>
            </p>
            <div id="emailContentArea" class="space-y-6">
                <!-- Email content for each pro will be injected here -->
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Data parsed from the uploaded PDF
        const PRO_AVAILABILITY_DATA = [
            { name: 'John Warren', email: 'john.warren@usta.com', monday: '9a-8:30p', tuesday: '9a-8:30p', wednesday: '9a-8:30p', thursday: '9a-8:30p', friday: '9a-8:30p', saturday: 'Not Available', sunday: 'Not Available' },
            { name: 'Rod Bailey', email: 'bailey@usta.com', monday: 'Available', tuesday: 'Available', wednesday: 'Available', thursday: 'Available', friday: '', saturday: 'Available', sunday: 'Available' },
            { name: 'Lindsay Baum', email: 'lindsay.baum@usta.com', monday: 'Available', tuesday: 'Available', wednesday: 'Available', thursday: 'Available', friday: 'Available', saturday: 'Available', sunday: 'Available' },
            { name: 'Justyna Wereszka', email: 'Justyna.wereszka@usta.com', monday: 'Available', tuesday: 'Available', wednesday: 'Available', thursday: 'Available NEW', friday: 'Available NEW', saturday: 'Not Available NEW', sunday: 'Not Available NEW' },
            { name: 'David Parra-Newton', email: 'david.parra-newton@usta.com', monday: '9am-7pm', tuesday: '9am-8:30pm NEW', wednesday: '9am-8:30pm NEW', thursday: '9am-8:30pm NEW', friday: '9am-5:30pm NEW', saturday: 'N/A', sunday: 'N/A NEW' },
            { name: 'Leo Correa', email: 'leo.correa@usta.com', monday: '9am-8:30 pm', tuesday: '9am-8:30pm NEW', wednesday: '9am-8:30 pm NEW', thursday: '9am-8:30 pm NEW', friday: '9am-6:30pm NEW', saturday: 'OFF NEW', sunday: 'OFF NEW' },
            { name: 'Nouri El-Hajjar', email: 'hajjar@usta.com', monday: '9am-8:30 pm', tuesday: '9-8:30 pm NEW', wednesday: '9am-8:30pm NEW', thursday: '9am-8:30pm NEW', friday: '9am-4pm NEW', saturday: 'Not Available NEW', sunday: '-N/A' },
            { name: 'Danny Ahn', email: 'danny.ahn@lusta.com', monday: '9am-8:30pm', tuesday: '9am-8:30pm NEW', wednesday: '9am-8:30pm NEW', thursday: '9am-8:30pm NEW', friday: '9am-4pm NEW', saturday: '', sunday: '(Summer NEW' },
            { name: 'Osas Akinniranye', email: 'osas.akinniranye@usta.com', monday: 'Available 9am', tuesday: 'Available 9am', wednesday: 'Available 9am', thursday: 'Available 9am', friday: 'Available 9am', saturday: 'Unavailable NEW', sunday: '' },
            { name: 'Stever Forte', email: 'Steven.forte@usta.com', monday: '9-8:30pm', tuesday: '9-8:30pm NEW', wednesday: '9-8:30pm NEW', thursday: '9-8:30pm NEW', friday: '', saturday: '9am-6:30pm', sunday: '' },
            { name: 'Ziryab Ahmed', email: 'ziryab.ahmed@usta.com', monday: 'Available', tuesday: 'Available', wednesday: 'Available', thursday: 'Available', friday: 'Available', saturday: '', sunday: '' },
            { name: 'Karla Noboa', email: 'karla.noboa@usta.com', monday: 'New 10am-8:30pm', tuesday: 'New 10am-8:30pm', wednesday: 'Available 10am-8:30prn', thursday: 'Available 10arn 8:30pm', friday: '9am-9:30pm', saturday: 'NEW OFF', sunday: 'NEW-OFF' },
            { name: 'Zack Ray', email: 'dedric.ray@usta.com', monday: 'Off', tuesday: 'Available', wednesday: 'Available', thursday: 'Available', friday: 'Available', saturday: '9AM-6:30 PM NEW', sunday: 'Off' },
            { name: 'Omer Khalifa', email: 'omer.khalifa@usta.com', monday: 'Available (New!)', tuesday: 'Available (New)', wednesday: 'Available (New)', thursday: 'Available (New)', friday: 'Available (New)', saturday: 'Off(new)**', sunday: 'Off (New)' },
            { name: 'Gustavo Alcayaga', email: 'gustavo.alcayaga@usta.com', monday: 'Summer 2025 9-4 pm', tuesday: 'Summer 2025 9-4 pm', wednesday: 'Summer 20259-4 pm', thursday: 'Summer 2025 9-4 pm', friday: 'Summer 2025 9-4 pm', saturday: 'N/A', sunday: 'N/A' },
            { name: 'Valeria Torres', email: 'valeria.torres@lusta.com', monday: 'NArbr', tuesday: 'N/A', wednesday: 'N/A', thursday: 'N/A', friday: '8 am-6pm NEW', saturday: 'N/A', sunday: 'N/A' },
            { name: 'Alex Hagiu', email: 'alexander.hagiu@usta.com', monday: 'Available', tuesday: 'N/A', wednesday: 'Available', thursday: 'N/A', friday: 'NA', saturday: 'Available', sunday: 'Available' },
            { name: 'Peter Wang', email: 'peter.wang@usta.com', monday: 'N/A', tuesday: '9am-8:30pm', wednesday: 'N/A', thursday: '9am 8:30pm', friday: '2pm-8:30pm', saturday: 'N/A', sunday: 'NA' },
            { name: 'Farhad Roshashanie', email: 'farhad.roshanale@usta.com', monday: 'INIA', tuesday: 'NXAC', wednesday: 'NIA', thursday: 'NOW', friday: 'N/A', saturday: 'NIA', sunday: 'NA' },
            { name: 'Jinny Welch', email: 'jinny.welch@usta.com', monday: 'N/A', tuesday: 'N/A', wednesday: 'N/A', thursday: 'NUA', friday: 'N/A NEW', saturday: 'N/A NEW', sunday: 'N/A' },
            { name: 'Viola Avdyli', email: 'viola.avdylimusta.com', monday: 'N/A', tuesday: 'N/A', wednesday: 'N/A', thursday: 'N/A', friday: 'N/A', saturday: '9am-4:30pm', sunday: '9am-4:30' },
            { name: 'Frederick Abunku', email: 'frederick.abunku@usta.com', monday: '6pm-10pm', tuesday: '6pm-10pm', wednesday: '6pm-10pm', thursday: 'BUA', friday: 'N/A', saturday: 'NIA', sunday: 'N/A' },
            { name: 'Daniel Cox', email: 'daniel.cox@usta.com', monday: 'N/A', tuesday: 'N/A', wednesday: 'N/A', thursday: 'NVA', friday: 'NA', saturday: 'NA NEW', sunday: 'NA NEW' },
            { name: 'Shaquille Hamilton', email: 'shaquille.hamilton@usta.com', monday: '8:30am-3pm', tuesday: '8:30am-3pm', wednesday: '8:30am-3pm', thursday: '8:30am-3pm', friday: 'N', saturday: '9am-2pm', sunday: 'N' },
            { name: 'Valery Cardona', email: 'valery.calderon@usta.com', monday: '9-4', tuesday: '9-4 pm (NEW)', wednesday: '9-4 pm (NEW]', thursday: '9-4 pm (NEW)', friday: '9-4 pm (NEW)', saturday: 'NWA INEW', sunday: 'NA' },
            { name: 'Mellanie Benitez', email: 'mellanie.benitez@usta.com', monday: '9-4 pm (NEW)', tuesday: '9-4 pm (NEW)', wednesday: '9-4 pm (NEW]', thursday: '9-4 pm (NEW)', friday: '9-4 pm. (NEW)', saturday: '9am-12pm', sunday: 'N/A' },
            { name: 'Lenny Brosnan', email: 'leonard.brosnan@usta.com', monday: 'INA', tuesday: 'N/A', wednesday: 'N/A', thursday: 'N/A', friday: 'TUA', saturday: 'N/A', sunday: 'N/A' },
            { name: 'Will McGarvey', email: 'william.mcgarvey@usta.com', monday: 'Barm-3pm NEW', tuesday: '8am-3pm NEW', wednesday: 'Barm-3pm NEW', thursday: '8am-3pm NEW', friday: 'Bam-3pm NEW', saturday: '', sunday: 'Barm-3pm NEW' },
            { name: 'Robert Childers', email: 'robert.childers@usta.com', monday: 'Available', tuesday: 'Available', wednesday: 'Available', thursday: 'Available', friday: 'Available (NEW)', saturday: 'Available (NEW)', sunday: 'Available' },
            { name: 'Felix Liew', email: 'felix.liewusta.com', monday: 'Available', tuesday: 'Available', wednesday: 'Available', thursday: 'Available', friday: 'Available', saturday: 'Available (New]', sunday: 'Citt (New)' },
            { name: 'Petra Frinculescu', email: 'petra.frinculescu@usta.com', monday: '1-10 pm NEW', tuesday: '9-4pm NEW', wednesday: '1-10pm NEW', thursday: '9-4pm NEW', friday: '1-10pm NEW', saturday: 'NANEW', sunday: 'N/A' },
            { name: 'Bilal Afzal', email: 'bilal.afzal@usta.com', monday: 'Available', tuesday: 'Available', wednesday: 'Available', thursday: 'Available', friday: 'NICA', saturday: '9a-4:30p', sunday: '9a-4:30p' },
            { name: 'Orlando Olmedo', email: 'alvaro.olmedo@usta.com', monday: 'Available', tuesday: 'Available', wednesday: 'Available', thursday: 'Available', friday: 'Available', saturday: 'Available', sunday: 'Available' },
            { name: 'Sophia Rodriguez', email: 'sophia.rodriguez2@usta.com', monday: 'Available NEW', tuesday: 'Available NEW', wednesday: 'Available NEW', thursday: 'Available NEW', friday: 'Available NEW', saturday: 'N/A', sunday: 'N/A' },
            { name: 'Rohan D\'Souza', email: 'rohan.dsouza@usta.com', monday: '7a-9am, 12pm-10pm', tuesday: '', wednesday: '7a-9am, 12pm-10pm', thursday: '7am-3pm', friday: '7a-9am, 12-5pm', saturday: 'N/A', sunday: 'N/A' },
        ];

        // Define all dates for each day
        const ALL_DATES_BY_DAY = {
            Monday: ['9/15', '9/22', '9/29', '10/6', '10/13', '10/20', '10/27', '11/3', '11/10', '11/17', '11/24', '12/1', '12/8', '12/15', '12/22', '12/29', '1/5'],
            Tuesday: ['9/16', '9/23', '9/30', '10/7', '10/14', '10/21', '10/28', '11/4', '11/11', '11/18', '11/25', '12/2', '12/9', '12/16', '12/23', '12/30', '1/6'],
            Wednesday: ['9/17', '9/24', '10/1', '10/8', '10/15', '10/22', '10/29', '11/5', '11/12', '11/19', '11/26', '12/3', '12/10', '12/17', '12/24', '12/31', '1/7'],
            Thursday: ['9/18', '9/25', '10/2', '10/9', '10/16', '10/23', '10/30', '11/6', '11/13', '11/20', '11/27', '12/4', '12/11', '12/18', '12/25', '1/1', '1/8'],
            Friday: ['9/19', '9/26', '10/3', '10/10', '10/17', '10/24', '10/31', '11/7', '11/14', '11/21', '11/28', '12/5', '12/12', '12/19', '12/26', '1/2', '1/9'],
            Saturday: ['9/20', '9/27', '10/4', '10/11', '10/18', '10/25', '11/1', '11/8', '11/15', '11/22', '11/29', '12/6', '12/13', '12/20', '12/27', '1/3', '1/10'],
            Sunday: ['9/21', '9/28', '10/5', '10/12', '10/19', '10/26', '11/2', '11/9', '11/16', '11/23', '11/30', '12/7', '12/14', '12/21', '12/28', '1/4', '1/11']
        };

        const SCHEDULE_CATEGORIES = {
            Daytime: {
                Monday: [
                    { name: 'Weekday Novice 102', time: '9A', weeklyCourts: ['Court 10', 'Court 10', 'Court 7', null, null, null, null, null, null, null, null, null, null, null, null, null, 'Court 7'] },
                    { name: 'Weekday NTC Rally', time: '9A', weeklyCourts: ['Court 10, 11', 'Court 10, 11', 'Court 8-9', null, null, null, null, null, null, null, null, null, null, null, null, null, 'Court 8-9'] },
                    { name: 'Weekday Drill & Play (Silver)', time: '10A', weeklyCourts: ['Court 11, 12', 'Court 11, 12', 'Court 10-11', null, null, null, null, null, null, null, null, null, null, null, null, null, 'Court 10-11'] },
                    { name: 'Weekday Lead Pro (Bronze)', time: '10:30A', weeklyCourts: ['Court 10, 11', 'Court 10, 11', 'Court 7-8', null, null, null, null, null, null, null, null, null, null, null, null, null, 'Court 7-8'] },
                    { name: 'Weekday NTC Daylights (Rally)', time: '12P', weeklyCourts: ['Court 10,11', 'Court 10, 11', 'Court 7-8', null, null, null, null, null, null, null, null, null, null, null, null, null, 'Court 7-8'] },
                    { name: 'Round Robin', time: '10A', weeklyCourts: ['Court 7 - 9', 'Court 7 - 9', 'Court 1-6', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Round Robin', time: '11:30A', weeklyCourts: ['Court 7 - 9', 'Court 7 - 9', 'Court 1-6', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                ],
                Tuesday: [
                    { name: 'NTC Breakfast Club (Bronze)', time: '7:30A', weeklyCourts: ['Court 7, 8', 'Court 7,8', 'Court 1,2', null, null, null, null, 'Court 5', null, null, null, null, null, null, null, null, null] },
                    { name: 'Weekday Stroke Series', time: '9A', weeklyCourts: ['Court 7,8,9', 'Court 7,8,9', 'Court 2,3,4', null, null, null, null, 'Court 7-9', null, null, null, null, null, null, null, null, null] },
                    { name: 'Weekday Intro To Tennis', time: '9A', weeklyCourts: ['Court 10', 'Court 10', 'Court 1', null, null, null, null, 'Court 5', null, null, null, null, null, null, null, null, null] },
                    { name: 'Weekday NTC Bronze', time: '10A', weeklyCourts: ['Court 7,8,9', 'Court 7,8,9', 'Court 2-5', null, null, null, null, 'Court 7-10', null, null, null, null, null, null, null, null, null] },
                    { name: 'Weekday Novice 102', time: '10A', weeklyCourts: ['Court 16', 'Court 16', 'Court 7', null, null, null, null, 'Court 7', null, null, null, null, null, null, null, null, null] },
                    { name: 'Weekday Advanced Zone', time: '10:30A', weeklyCourts: ['Court 10', 'Court 10', 'Court 1', null, null, null, null, 'Court 5', null, null, null, null, null, null, null, null, null] },
                    { name: 'Weekday NTC Gold', time: '10A', weeklyCourts: ['Court 15, 14', 'Court 15, 14', 'Court 8--9', null, null, null, null, 'Court 11-12', null, null, null, null, null, null, null, null, null] },
                    { name: 'Weekday Intro To Tennis', time: '11:30A', weeklyCourts: ['Court 16', 'Court 16', 'Court 7-8', null, null, null, null, 'Court 7', null, null, null, null, null, null, null, null, null] },
                ],
                Wednesday: [
                    { name: 'Round Robin', time: '10A', weeklyCourts: ['Court 7-9', 'Court 7-9', 'Court 1-6', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Round Robin', time: '11:30A', weeklyCourts: ['Court 7-9', 'Court 7-9', 'Court 1-6', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Breakfast Club (Rally)', time: '7:30A', weeklyCourts: ['Court 10', 'Court 10', 'Court 7', null, null, null, null, 'Court 10', null, null, null, null, null, null, null, null, null] },
                    { name: 'Weekday Lead Pro (Bronze)', time: '9A', weeklyCourts: ['COurt 10', 'Court 10', 'Court 7', null, null, null, null, 'Court 10', null, null, null, null, null, null, null, null, null] },
                    { name: 'Weekday Novice 102', time: '9A', weeklyCourts: ['Court 11', 'Court 11', 'Court 8', null, null, null, null, 'Court 11', null, null, null, null, null, null, null, null, null] },
                    { name: 'Weekday NTC Rally', time: '9A', weeklyCourts: ['Court 12', 'Court 12', 'Court 9', null, null, null, null, 'Court 12', null, null, null, null, null, null, null, null, null] },
                    { name: 'Weekday NTC Silver', time: '10:30A', weeklyCourts: ['Court 10', 'Court 10', 'Court 7', null, null, null, null, 'Court 10', null, null, null, null, null, null, null, null, null] },
                    { name: 'Weekday Intro To Tennis', time: '10:30A', weeklyCourts: ['Court 11', 'Court 11', 'Court 8', null, null, null, null, 'Court 11', null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Daylights (Bronze)', time: '10:30A', weeklyCourts: ['Court 12', 'Court 12', 'Court 9', null, null, null, null, 'Court 12', null, null, null, null, null, null, null, null, null] },
                ],
                Thursday: [
                    { name: 'Round Robin', time: '10A', weeklyCourts: ['Court 7-9', 'Court 7-9', 'Court 1-6', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Round Robin', time: '11:30A', weeklyCourts: ['Court 7-9', 'Court 7-9', 'Court 1-6', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Breakfast Club (Silver)', time: '7:30A', weeklyCourts: ['Court 10', 'Court 10', 'Court 7', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Weekday Lead Pro (Bronze)', time: '9A', weeklyCourts: ['Court 10', 'Court 10', 'Court 7', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Weekday Lead Pro (Silver)', time: '10:30A', weeklyCourts: ['Court 10', 'Court 10', 'Court 7', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Weekday Advanced Zone', time: '10:30A', weeklyCourts: ['Court 11', 'Court 11', 'Court 8', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Weekday NTC Daylights (Rally)', time: '12P', weeklyCourts: ['Court 10', 'Court 10', 'Court 7', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Evaluations', time: '9 to 10:30A', weeklyCourts: ['Court 11', 'Court 11', 'Court 8', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                ],
                Friday: [
                    { name: 'Director\'s Cut (Silver)', time: '9A', weeklyCourts: ['Court 7-8', 'Court 7-8', 'Court 7-8', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Weekday Intro To Tennis', time: '9A', weeklyCourts: ['Court 9', 'Court 9', 'Court 9', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Weekday Novice 102', time: '10A', weeklyCourts: ['Court 10-11', 'Court 10-11', 'Court 1', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Weekday NTC Bronze', time: '10A', weeklyCourts: ['Court 12', 'Court 12', 'Court 3', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Weekday NTC Rally', time: '10:30A', weeklyCourts: ['Court 7-9', 'Court 7-9', 'Court 7-9', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                ]
            },
            Evenings: {
                Monday: [
                    { name: 'Intro To Tennis', time: '6P', weeklyCourts: ['Court 13', 'Court 13', 'Court 1', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Intro To Tennis', time: '7P', weeklyCourts: ['Court 7', 'Court 7', 'Court 7', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Novice 102', time: '7P', weeklyCourts: ['Court 10-12', 'Court 10-12', 'Court 10-12', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Rally', time: '7P', weeklyCourts: ['Court 7-9', 'Court 7-9', 'Court 7-9', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Bronze', time: '8P', weeklyCourts: ['Court 11,12', 'Court 11,12', 'Court 5,6', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Silver', time: '8P', weeklyCourts: ['Court 14', 'Court 14', 'Court 4', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Gold', time: '7P', weeklyCourts: ['Court 12', 'Court 12', 'Court 12', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Stroke Series: Volley', time: '8:30P', weeklyCourts: ['Court 8,9', 'Court 8,9', 'Court 8,9', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Zone', time: '8P', weeklyCourts: ['Court 16,15', 'Court 16,15', 'Court 2,3', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Night Lights (Gold)', time: '7:30P', weeklyCourts: ['Court 13', 'Court 13', 'Court 1', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Drill & Play (Bronze)', time: '6P', weeklyCourts: ['Court 16,15,14', 'Court 16,15,14', 'Court 2-4', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                ],
                Tuesday: [
                    { name: 'Intro to Tennis 101', time: '6:00 PM', weeklyCourts: ['Court 10', 'Court 10', 'Court 10', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Intro to Tennis 101', time: '7:00 PM', weeklyCourts: ['Court 11', 'Court 11', 'Court 1', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Rally', time: '6PM', weeklyCourts: ['Court 11', 'Court 11', 'Court 11', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Rally', time: '8P', weeklyCourts: ['Court 15,16', 'Court 15,16', 'Court 5-9', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Bronze', time: '8:30 PM', weeklyCourts: ['Court 11', 'Court 11', 'Court 1', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Silver', time: '7:30 PM', weeklyCourts: ['Court 10', 'Court 10', 'Court 10', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Stroke SERVE', time: '7:00 PM', weeklyCourts: ['Court 7,8', 'Court 7,8', 'Court 7,8', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'ZONE', time: '7:30 PM', weeklyCourts: ['Court 11,12', 'Court 11,12', 'Court 11,12', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Night Lights (Silver)', time: '7P', weeklyCourts: ['Court 12', 'Court 12', 'Court 2', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Night Lights (Gold)', time: '8:30P', weeklyCourts: ['Court 12', 'Court 12', 'Court 2', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Drill & Play Silver', time: '7:00 PM', weeklyCourts: ['Court 13', 'Court 13', 'Court 3', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Drill & Play Gold', time: '8:00 PM', weeklyCourts: ['Court 14', 'Court 14', 'Court 4', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                ],
                Wednesday: [
                    { name: 'Intro to Tennis 101', time: '8:00 PM', weeklyCourts: ['Court 11', 'Court 11', 'Court 2', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Novice 102', time: '7:00 PM', weeklyCourts: ['Court 10,11', 'Court 10,11', 'Court 10,11', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Novice 102', time: '8:00 PM', weeklyCourts: ['Court 12', 'Court 12', 'Court 3', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Rally', time: '7:00 PM', weeklyCourts: ['Court 12', 'Court 12', 'Court 12', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Rally', time: '8:30 PM', weeklyCourts: ['Court 10', 'Court 10', 'Court 10', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Bronze', time: '8:00 PM', weeklyCourts: ['Court 14', 'Court 14', 'Court 5', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Silver', time: '8:00 PM', weeklyCourts: ['Court 13', 'Court 13', 'Court 6', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Gold', time: '8:00 PM', weeklyCourts: ['Court 15', 'Court 15', 'Court 4', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Gold', time: '8:30P', weeklyCourts: ['Court 7', 'Court 7', 'Court 7', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'ZONE', time: '7:00 PM', weeklyCourts: ['Court 7,8', 'Court 7,8', 'Court 7,8', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Advanced ZONE', time: '7:00 PM', weeklyCourts: ['Court 9', 'Court 9', 'Court 9', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Night Lights Rally', time: '8:00 PM', weeklyCourts: ['Court 16', 'Court 16', 'Court 1', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Night Lights Rally', time: '8:30 PM', weeklyCourts: ['Court 8', 'Court 8', 'Court 8', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Drill & Play Rally', time: '6:00 PM', weeklyCourts: ['Court 16', 'Court 16', 'Court 1', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                ],
                Thursday: [
                    { name: 'NTC Bronze', time: '5:30 PM', weeklyCourts: ['Court 7', 'Court 7', 'Court 7', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Bronze', time: '7P', weeklyCourts: ['Court 7,8', 'Court 7,8', 'Court 7,8', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Rally', time: '7:00 PM', weeklyCourts: ['Court 9', 'Court 9', 'Court 9', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Stroke BACKHAND', time: '6:00 PM', weeklyCourts: ['Court 8-9', 'Court 8-9', 'Court 8-9', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Rally', time: '7:30P', weeklyCourts: ['Court 8,9,10', 'Court 8,9,10', 'Court 1,2,5', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Bronze', time: '8P', weeklyCourts: ['Court 14', 'Court 14', 'Court 3', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Advanced Zone', time: '8P', weeklyCourts: ['Court 15', 'Court 15', 'Court 4', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Zone', time: '8P', weeklyCourts: ['Court 16,15', 'Court 16', 'Court 6', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Night Lights (Gold)', time: '6P', weeklyCourts: ['Court 16,15', 'Court 16,15', 'Court 3,4', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                ],
                Friday: [
                    { name: 'Novice 102', time: '5:30 PM', weeklyCourts: ['Court 10,11', 'Court 10,11', 'Court 10,11', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Rally', time: '7:30 PM', weeklyCourts: ['Court 16,15', 'Court 16,15', 'Court 1,2', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Bronze', time: '7:30P', weeklyCourts: ['Court 14,13', 'Court 14,13', 'Court 3,4', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'ZONE', time: '7:30 PM', weeklyCourts: ['Court 11,12', 'Court 11,12', 'Court 5,6', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Night Lights (Silver)', time: '7P', weeklyCourts: ['Court 12', 'Court 12', 'Court 12', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                ]
            },
            Weekends: {
                Saturday: [
                    { name: 'Intro To Tennis 101', time: '9:00A', weeklyCourts: ['Court 10,11,12', 'Court 10,11,12', 'Court 10,11,12', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Intro To Tennis 101', time: '10:30A', weeklyCourts: ['Court 13', 'Court 13', 'Court 1', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Intro To Tennis 101', time: '12:00P', weeklyCourts: ['Court 13', 'Court 13', 'Court 1', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Novice 102', time: '10:30A', weeklyCourts: ['Court 10,11', 'Court 10,11', 'Court 10,11', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Novice 102', time: '12:00P', weeklyCourts: ['Court 12', 'Court 12', 'Court 12', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Rally', time: '9:00A', weeklyCourts: ['Court 11', 'Court 11', 'Court 1', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Rally', time: '10:30A', weeklyCourts: ['Court 11', 'Court 11', 'Court 2', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Rally', time: '12:00P', weeklyCourts: ['Court 10,11', 'Court 10,11', 'Court 10,11', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Bronze', time: '9:00A', weeklyCourts: ['Court 2,3', 'Court 2,3', 'Court 2,3', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Bronze', time: '10:30A', weeklyCourts: ['Court 12', 'Court 12', 'Court 12', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Bronze', time: '12:00P', weeklyCourts: ['Court 14', 'Court 14', 'Court 2', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Silver', time: '10:30A', weeklyCourts: ['Court 16,15,14', 'Court 16,15,14', 'Court 4,5,6', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Gold', time: '12:00P', weeklyCourts: ['Court 16,15', 'Court 16,15', 'Court 3,4', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'ZONE', time: '9:00A', weeklyCourts: ['Court 16,15,14', 'Court 16,15,14', 'Court 4,5,6', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Advanced ZONE', time: '1:30P', weeklyCourts: ['Court 1', 'Court 1', 'Court 1', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                ],
                Sunday: [
                    { name: 'Intro To Tennis 101', time: '10:30A', weeklyCourts: ['Court 10,11', 'Court 10,11', 'Court 10,11', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Novice 102', time: '9:00A', weeklyCourts: ['Court 10,11', 'Court 10,11', 'Court 10,11', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Novice 102', time: '10:30A', weeklyCourts: ['Court 12', 'Court 12', 'Court 12', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Rally', time: '9:00A', weeklyCourts: ['Court 16,15,14', 'Court 16,15,14', 'Court 1,2,3', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Bronze', time: '9:00A', weeklyCourts: ['Court 8,9,10', 'Court 8,9,10', 'Court 4,5,6', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Rally', time: '10:30A', weeklyCourts: ['Court 16,15', 'Court 16,15', 'Court 5,6', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'Advanced ZONE', time: '10:30A', weeklyCourts: ['Court 11', 'Court 11', 'Court 1', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Bronze', time: '10:30A', weeklyCourts: ['Court 14,13', 'Court 14,13', 'Court 3,4', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Silver', time: '12:00P', weeklyCourts: ['Court 14', 'Court 14', 'Court 5', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Gold', time: '12:00P', weeklyCourts: ['Court 16,15', 'Court 16,15', 'Court 3,4', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'ZONE', time: '12:00P', weeklyCourts: ['Court 11', 'Court 11', 'Court 1,2,3', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                    { name: 'NTC Rally', time: '1:30P', weeklyCourts: ['Court 11', 'Court 11', 'Court 1', null, null, null, null, null, null, null, null, null, null, null, null, null, null] },
                ]
            }
        };

        // Your Firebase Configuration (UPDATED)
        const firebaseConfig = {
            apiKey: "AIzaSyAuIqhrh4KbvRyB07UB-NvDz5dK-XRFAW0",
            authDomain: "ntc-pro-scheduler.firebaseapp.com",
            projectId: "ntc-pro-scheduler",
            storageBucket: "ntc-pro-scheduler.firebasestorage.app",
            messagingSenderId: "405568766027",
            appId: "1:405568766027:web:b4f61ffb74458a61270dce",
            measurementId: "G-1HQ35F9F6N"
        };

        let db;
        let auth;
        let currentUserId;
        let scheduleState = {}; // Will hold only the current week's data
        let currentCategory = 'Daytime'; // New: Default to Daytime
        let currentDay = 'Monday'; // Default to Monday
        let currentWeekIndex = 0; // Index for current week in ALL_DATES_BY_DAY

        // Helper function to parse time strings into minutes from midnight for comparison
        const parseTime = (timeStr) => {
            const normalizedTime = timeStr.replace(/ /g, '').toLowerCase();
            
            // Handle specific custom time notations (e.g., "Barm" for 8am)
            if (normalizedTime.startsWith('barm')) {
                return 8 * 60; // 8:00 AM
            }

            const match = normalizedTime.match(/(\d+)(?::(\d+))?([ap]?m?)?/);
            if (!match) return null;

            let hours = parseInt(match[1]);
            const minutes = parseInt(match[2] || '0');
            const ampm = match[3];

            if (ampm === 'p' && hours !== 12) {
                hours += 12;
            }
            if (ampm === 'a' && hours === 12) {
                hours = 0;
            }
            return hours * 60 + minutes;
        };

        const isProAvailableForClass = (proAvailability, classTime) => {
            if (!proAvailability) return false;
            const classTimeNormalized = classTime.toLowerCase().replace(/ /g, '');
            const classStartTime = parseTime(classTimeNormalized.split('to')[0].trim());
            const classEndTime = parseTime(classTimeNormalized.split('to')[1]?.trim() || classTimeNormalized);

            if (classStartTime === null) return false;

            if (proAvailability.toLowerCase().includes('available')) {
                return true;
            }

            const unavailableKeywords = ['off', 'n/a', 'nia', 'tua', 'unavailable', 'inarbr', 'nva', 'nica', 'bua', 'now', 'n', '', 'citt', 'nanew']; // Added 'citt' and 'nanew'
            if (unavailableKeywords.some(keyword => proAvailability.toLowerCase().includes(keyword))) {
                return false;
            }

            const ranges = proAvailability.split(/, | and /).filter(s => s.trim().length > 0);
            for (const range of ranges) {
                const timeParts = range.match(/(\d+)(:\d+)?(a?m?|p?m?)\s*-\s*(\d+)(:\d+)?(a?m?|p?m?)/i);
                if (timeParts) {
                    const startStr = (timeParts[1] + (timeParts[2] || '') + (timeParts[3] || '')).trim();
                    const endStr = (timeParts[4] + (timeParts[5] || '') + (timeParts[6] || '')).trim();
                    const startTime = parseTime(startStr);
                    const endTime = parseTime(endStr);
                    if (startTime !== null && endTime !== null) {
                        if (endTime < startTime) { // Handles overnight shifts
                            if ((classStartTime >= startTime && classStartTime <= 24*60) || (classEndTime >= 0 && classEndTime <= endTime)) {
                                return true;
                            }
                        } else if (classStartTime >= startTime && classEndTime <= endTime) {
                            return true;
                        }
                    }
                } else {
                    const singleTimeMatch = range.match(/(\d+)(:\d+)?(a?m?|p?m?)/i);
                    if (singleTimeMatch) {
                        const singleTimeStr = (singleTimeMatch[1] + (singleTimeMatch[2] || '') + (singleTimeMatch[3] || '')).trim();
                        const singleTime = parseTime(singleTimeStr);
                        if (singleTime !== null && classStartTime >= singleTime) {
                            return true;
                        }
                    }
                }
            }
            return false;
        };

        // This function now *creates and saves* individual weekly documents
        const initializeAndSaveAllWeeklySchedules = async () => {
            const appIdForFirestore = firebaseConfig.projectId;
            // Reference to the 'weeks' subcollection under schedules/{appId}
            const weeksCollectionRef = collection(db, 'schedules', appIdForFirestore, 'weeks'); 
            
            for (const category of Object.keys(SCHEDULE_CATEGORIES)) {
                for (const day of Object.keys(SCHEDULE_CATEGORIES[category])) {
                    for (const classItem of SCHEDULE_CATEGORIES[category][day]) {
                        for (const [index, date] of ALL_DATES_BY_DAY[day].entries()) {
                            const formattedDate = date.replace(/\//g, '-'); // e.g., 9-15
                            // Create a unique document ID for each class instance in a specific week
                            const docId = `${formattedDate}-${day}-${classItem.name.replace(/[^a-zA-Z0-9]/g, '')}-${classItem.time.replace(/[^a-zA-Z0-9]/g, '')}`; 

                            // Only initialize if the class is offered this week (court is not null)
                            if (classItem.weeklyCourts[index] !== null) {
                                const dayAvailabilityKey = day.toLowerCase();
                                
                                const availablePros = PRO_AVAILABILITY_DATA
                                    .filter(pro => isProAvailableForClass(pro[dayAvailabilityKey], classItem.time))
                                    .map(pro => pro.name);
                                
                                const weeklyClassData = {
                                    category: category,
                                    day: day,
                                    className: classItem.name,
                                    time: classItem.time,
                                    date: date,
                                    court: classItem.weeklyCourts[index],
                                    pros: [], // Initially empty array for assigned pros
                                    availablePros: availablePros.sort() // Available pros for this specific class instance
                                };
                                try {
                                    // Set each weekly class instance as a separate document
                                    await setDoc(doc(weeksCollectionRef, docId), weeklyClassData);
                                } catch (e) {
                                    console.error(`Error setting document for ${docId}:`, e);
                                }
                            }
                        }
                    }
                }
            }
            console.log("All initial weekly schedule documents created in Firestore.");
        };

        // This function now fetches only the data for the current week and updates scheduleState
        const fetchAndRenderCurrentWeek = async () => {
            const appIdForFirestore = firebaseConfig.projectId;
            const currentWeekDate = ALL_DATES_BY_DAY[currentDay]?.[currentWeekIndex];
            
            if (!currentWeekDate) {
                document.getElementById('currentWeekDisplay').innerText = 'No Week Selected';
                document.getElementById('schedule-container').innerHTML = `<p class="text-center text-gray-400">No classes for this week.</p>`;
                return;
            }

            const formattedWeekDate = currentWeekDate.replace(/\//g, '-'); // e.g., 9-15
            
            // Reference to the 'weeks' subcollection
            const weeksCollectionRef = collection(db, 'schedules', appIdForFirestore, 'weeks'); 
            
            // Query for documents that match the current week's date and day
            // Note: Firestore queries are limited. We're fetching all and filtering in-memory for simplicity.
            // For very large datasets, you'd add more specific queries (e.g., where('date', '==', currentWeekDate))
            // but this would require composite indexes in Firestore.
            const q = query(weeksCollectionRef); 

            try {
                const querySnapshot = await getDocs(q);
                let fetchedWeeklyData = {}; // Temporary object to reconstruct the full schedule structure
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Reconstruct the scheduleState from individual documents
                    if (!fetchedWeeklyData[data.category]) fetchedWeeklyData[data.category] = {};
                    if (!fetchedWeeklyData[data.category][data.day]) fetchedWeeklyData[data.category][data.day] = {};
                    if (!fetchedWeeklyData[data.category][data.day][data.className]) {
                        fetchedWeeklyData[data.category][data.day][data.className] = { weeklyAssignments: {} };
                    }
                    fetchedWeeklyData[data.category][data.day][data.className].weeklyAssignments[data.date] = {
                        pros: data.pros || [],
                        availablePros: data.availablePros || [],
                        court: data.court || null
                    };
                });
                scheduleState = fetchedWeeklyData; // Update the global scheduleState
                console.log("scheduleState after fetching all weekly docs:", scheduleState);
                renderSchedule(); // Render the UI with the fetched data
            } catch (err) {
                console.error("Error fetching weekly schedule data:", err);
                document.getElementById('schedule-container').innerHTML = `<div class="text-red-400">Failed to load schedule data. Please check your connection.</div>`;
            }
        };


        const renderSchedule = () => {
            const container = document.getElementById('schedule-container');
            container.innerHTML = '';
            
            const currentWeekDate = ALL_DATES_BY_DAY[currentDay]?.[currentWeekIndex];
            document.getElementById('currentWeekDisplay').innerText = currentWeekDate ? `Week of ${currentWeekDate}` : 'No Week Selected';

            console.log("--- renderSchedule called ---");
            console.log("scheduleState:", scheduleState); // This should now have the full structure
            console.log("currentCategory:", currentCategory);
            console.log("currentDay:", currentDay);
            console.log("currentWeekIndex:", currentWeekIndex);
            console.log("currentWeekDate:", currentWeekDate);

            // Check if the necessary nested data exists for the current view
            if (!scheduleState || !scheduleState[currentCategory] || !scheduleState[currentCategory][currentDay] || !currentWeekDate) {
                console.log("Rendering 'Loading schedule...' due to incomplete state.");
                container.innerHTML = `<p class="text-center text-gray-400">Loading schedule...</p>`;
                return;
            }

            const classesForDay = SCHEDULE_CATEGORIES[currentCategory][currentDay];
            const scheduleForDayInCurrentCategory = scheduleState[currentCategory][currentDay];

            if (!classesForDay || classesForDay.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-400">No classes scheduled for ${currentDay} in ${currentCategory} session.</p>`;
                return;
            }

            classesForDay.forEach(classItem => {
                const classWeekState = scheduleForDayInCurrentCategory[classItem.name]?.weeklyAssignments[currentWeekDate];
                
                // If class is not offered this week (court is null), skip rendering its card
                if (!classWeekState || classWeekState.court === null) {
                    return;
                }

                const assignedPros = classWeekState.pros;
                const availablePros = classWeekState.availablePros;
                const courtInfo = classWeekState.court;

                const assignedProsHtml = assignedPros.length > 0
                    ? assignedPros.map(pro => `<span class="inline-block bg-emerald-700 text-white text-sm px-3 py-1 rounded-full font-semibold">${pro}</span>`).join(' ')
                    : '<span class="text-gray-500">Unassigned</span>';

                const prosCheckboxes = availablePros.map(pro => {
                    const isChecked = assignedPros.includes(pro);
                    // A pro is disabled if they are already assigned to another class at the same time slot on THIS specific week
                    const isAssignedElsewhereAtSameTime = Object.keys(scheduleForDayInCurrentCategory)
                        .filter(otherClassName => otherClassName !== classItem.name)
                        .some(otherClassName => {
                            const otherClassTime = SCHEDULE_CATEGORIES[currentCategory][currentDay].find(c => c.name === otherClassName)?.time;
                            const currentClassTime = classItem.time;
                            const otherClassWeekState = scheduleForDayInCurrentCategory[otherClassName]?.weeklyAssignments[currentWeekDate];

                            return otherClassTime === currentClassTime && otherClassWeekState?.pros.includes(pro);
                        });
                    
                    const isDisabled = isAssignedElsewhereAtSameTime && !isChecked;
                    
                    return `
                        <label class="flex items-center space-x-2 text-gray-300 ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}">
                            <input
                                type="checkbox"
                                name="pro-${classItem.name}-${currentWeekDate}"
                                value="${pro}"
                                class="form-checkbox h-4 w-4 text-emerald-500 rounded-md"
                                ${isChecked ? 'checked' : ''}
                                ${isDisabled ? 'disabled' : ''}
                                data-class-name="${classItem.name}"
                                data-pro-name="${pro}"
                                data-week-date="${currentWeekDate}"
                            />
                            <span>${pro}</span>
                        </label>
                    `;
                }).join('');

                const cardHtml = `
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 hover:border-emerald-500 transition-all duration-300">
                        <h2 class="text-2xl font-bold mb-2 text-white">${classItem.name}</h2>
                        <p class="text-gray-400 mb-2">Time: ${classItem.time}</p>
                        <p class="text-gray-400 mb-4">Court: ${courtInfo}</p>
                        <div class="mb-4">
                            <h3 class="text-lg font-semibold text-emerald-300 mb-2">Assigned Pros:</h3>
                            <div class="flex flex-wrap gap-2">
                                ${assignedProsHtml}
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-300 mb-2">Available Pros:</h3>
                            <div class="flex flex-wrap gap-4 mb-4">
                                ${prosCheckboxes}
                            </div>
                            <button class="assign-all-instances-btn px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors"
                                    data-class-name="${classItem.name}"
                                    data-current-category="${currentCategory}"
                                    data-current-day="${currentDay}">
                                Assign All Instances for This Day
                            </button>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', cardHtml);
            });

            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const { className, proName, weekDate } = e.target.dataset;
                    const isChecked = e.target.checked;
                    handleAssignPro(className, proName, isChecked, weekDate);
                });
            });

            document.querySelectorAll('.assign-all-instances-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const { className, currentCategory: categoryForAssignment, currentDay: dayForAssignment } = e.target.dataset;
                    assignAllInstancesForClass(className, categoryForAssignment, dayForAssignment);
                });
            });
        };

        const handleAssignPro = async (className, proName, isChecked, weekDate) => {
            if (!db || !currentUserId) {
                console.error("Database not ready.");
                return;
            }

            const appIdForFirestore = firebaseConfig.projectId;
            const formattedWeekDate = weekDate.replace(/\//g, '-');
            // Construct the exact document ID for the specific class instance
            const classTimeForDocId = SCHEDULE_CATEGORIES[currentCategory][currentDay].find(c => c.name === className).time.replace(/[^a-zA-Z0-9]/g, '');
            const docId = `${formattedWeekDate}-${currentDay}-${className.replace(/[^a-zA-Z0-9]/g, '')}-${classTimeForDocId}`;
            
            const weeksCollectionRef = collection(db, 'schedules', appIdForFirestore, 'weeks'); 
            const weekDocRef = doc(weeksCollectionRef, docId);
            
            try {
                const docSnap = await getDoc(weekDocRef);
                if (docSnap.exists()) {
                    const currentData = docSnap.data();
                    let updatedPros = currentData.pros || [];
                    if (isChecked) {
                        if (!updatedPros.includes(proName)) {
                            updatedPros.push(proName);
                        }
                    } else {
                        updatedPros = updatedPros.filter(p => p !== proName);
                    }
                    updatedPros.sort(); // Keep sorted

                    await setDoc(weekDocRef, { pros: updatedPros }, { merge: true });
                    console.log(`Updated ${className} on ${weekDate} with pros:`, updatedPros);
                    // Re-fetch and render to update UI and other checkboxes
                    await fetchAndRenderCurrentWeek(); 
                } else {
                    console.error(`Document for ${className} on ${weekDate} not found. Cannot update.`);
                }
            } catch (err) {
                console.error("Failed to update schedule for single class:", err);
            }
        };

        const assignAllInstancesForClass = async (className, categoryForAssignment, dayForAssignment) => {
            if (!db || !currentUserId) {
                console.error("Database not ready.");
                return;
            }

            const currentWeekDate = ALL_DATES_BY_DAY[currentDay]?.[currentWeekIndex];
            if (!currentWeekDate) return;

            // Get the currently selected pros for this class in the current week
            const selectedProsForCurrentWeek = scheduleState[categoryForAssignment][dayForAssignment][className].weeklyAssignments[currentWeekDate].pros;

            if (selectedProsForCurrentWeek.length === 0) {
                console.error("Please select at least one pro for this class in the current week before using 'Assign All Instances'.");
                alert("Please select at least one pro for this class in the current week before using 'Assign All Instances'.");
                return;
            }

            const appIdForFirestore = firebaseConfig.projectId;
            const weeksCollectionRef = collection(db, 'schedules', appIdForFirestore, 'weeks'); // Updated path

            let promises = [];

            ALL_DATES_BY_DAY[dayForAssignment].forEach(weekDate => {
                const classOffering = SCHEDULE_CATEGORIES[categoryForAssignment][dayForAssignment].find(cls => cls.name === className);
                const weekIndex = ALL_DATES_BY_DAY[dayForAssignment].indexOf(weekDate);

                if (classOffering && classOffering.weeklyCourts[weekIndex] !== null) {
                    const formattedDate = weekDate.replace(/\//g, '-');
                    const classTimeForDocId = classOffering.time.replace(/[^a-zA-Z0-9]/g, '');
                    const docId = `${formattedDate}-${dayForAssignment}-${className.replace(/[^a-zA-Z0-9]/g, '')}-${classTimeForDocId}`;
                    const weekDocRef = doc(weeksCollectionRef, docId);

                    // Prepare the update for this specific weekly document
                    promises.push(setDoc(weekDocRef, { pros: selectedProsForCurrentWeek }, { merge: true })
                        .catch(err => console.error(`Failed to update all instances for ${docId}:`, err))
                    );
                }
            });

            try {
                await Promise.all(promises);
                console.log(`Assigned selected pros to all instances of "${className}" on ${dayForAssignment}s.`);
                alert(`Assigned selected pros to all instances of "${className}" on ${dayForAssignment}s.`);
                // Re-fetch and render the entire current week to reflect changes if needed,
                // although onSnapshot should handle this for the current view.
                fetchAndRenderCurrentWeek(); 
            } catch (err) {
                console.error("Failed to assign to all instances. Please try again:", err);
                alert("Failed to assign to all instances. Please try again.");
            }
        };


        const renderCategoryTabs = () => {
            const categoryTabContainer = document.getElementById('category-tabs');
            categoryTabContainer.innerHTML = '';
            const categories = Object.keys(SCHEDULE_CATEGORIES);

            categories.forEach(category => {
                const isActive = category === currentCategory;
                const buttonClass = isActive
                    ? 'bg-emerald-600 text-white'
                    : 'bg-gray-800 text-gray-300 hover:bg-gray-700';

                const tabHtml = `
                    <button
                        class="px-6 py-2 rounded-t-lg font-bold transition-colors ${buttonClass}"
                        data-category="${category}"
                    >
                        ${category}
                    </button>
                `;
                categoryTabContainer.insertAdjacentHTML('beforeend', tabHtml);
            });

            document.querySelectorAll('#category-tabs button').forEach(button => {
                button.addEventListener('click', (e) => {
                    currentCategory = e.target.dataset.category;
                    // Reset day and week when changing category
                    currentDay = Object.keys(SCHEDULE_CATEGORIES[currentCategory])[0]; 
                    currentWeekIndex = 0;
                    renderCategoryTabs(); // Re-render category tabs to update active state
                    renderDayTabs(); // Re-render day tabs for the new category
                    fetchAndRenderCurrentWeek(); // Fetch and render for the new category/day
                });
            });
        };

        const renderDayTabs = () => {
            const dayTabContainer = document.getElementById('day-tabs');
            dayTabContainer.innerHTML = '';
            const daysInCurrentCategory = Object.keys(SCHEDULE_CATEGORIES[currentCategory]);

            daysInCurrentCategory.forEach(day => {
                const isActive = day === currentDay;
                const buttonClass = isActive
                    ? 'bg-emerald-600 text-white'
                    : 'bg-gray-800 text-gray-300 hover:bg-gray-700';

                const tabHtml = `
                    <button
                        class="px-6 py-2 rounded-t-lg font-bold transition-colors ${buttonClass}"
                        data-day="${day}"
                    >
                        ${day}
                    </button>
                `;
                dayTabContainer.insertAdjacentHTML('beforeend', tabHtml);
            });

            document.querySelectorAll('#day-tabs button').forEach(button => {
                button.addEventListener('click', (e) => {
                    currentDay = e.target.dataset.day;
                    currentWeekIndex = 0; // Reset to first week when changing day
                    renderDayTabs(); // Re-render day tabs to update active state
                    fetchAndRenderCurrentWeek(); // Fetch and render for the new day
                });
            });
        };

        // Function to get the current day of the week as a string (e.g., "Monday")
        const getCurrentDayOfWeek = () => {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const date = new Date();
            return days[date.getDay()];
        };

        // Function to format date for Firestore document ID
        const formatDateForFirestore = (dateString) => {
            const parts = dateString.split('/');
            if (parts.length === 2) {
                // Assuming MM/DD format, add a default year (e.g., 2024 for 9/15)
                // This is a simplification; for real apps, better date handling is needed.
                return `2024-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
            }
            return dateString.replace(/\//g, '-'); // Fallback for other formats
        };

        // Function to generate and display today's schedule email content
        const showTodayScheduleEmail = async () => {
            const today = getCurrentDayOfWeek();
            const emailContentArea = document.getElementById('emailContentArea');
            emailContentArea.innerHTML = ''; // Clear previous content

            // Find the current week's date for today
            let todayWeekDate = null;
            let todayCategory = null;
            let todayDayClasses = null;

            // Iterate through all categories and days to find today's classes
            for (const categoryKey of Object.keys(SCHEDULE_CATEGORIES)) {
                if (SCHEDULE_CATEGORIES[categoryKey][today]) {
                    todayCategory = categoryKey;
                    todayDayClasses = SCHEDULE_CATEGORIES[categoryKey][today];
                    // Find the current week index for today's date
                    const todayDate = new Date().toLocaleDateString('en-US', { month: 'numeric', day: 'numeric' }); // e.g., "9/15"
                    const currentYear = new Date().getFullYear(); // Get current year
                    
                    const allDatesForToday = ALL_DATES_BY_DAY[today];
                    const matchingWeekIndex = allDatesForToday.findIndex(date => {
                        const [month, day] = date.split('/');
                        const scheduleDate = new Date(currentYear, parseInt(month) - 1, parseInt(day));
                        const todayFullDate = new Date();
                        return scheduleDate.getMonth() === todayFullDate.getMonth() &&
                               scheduleDate.getDate() === todayFullDate.getDate();
                    });

                    if (matchingWeekIndex !== -1) {
                         todayWeekDate = allDatesForToday[matchingWeekIndex];
                         currentWeekIndex = matchingWeekIndex; // Set currentWeekIndex to today's week
                         currentDay = today; // Set currentDay to today
                         currentCategory = todayCategory; // Set currentCategory to today's category
                         renderCategoryTabs(); // Update active category tab
                         renderDayTabs(); // Update active day tab
                         break; // Found today's schedule
                    }
                }
            }

            if (!todayDayClasses || !todayWeekDate) {
                emailContentArea.innerHTML = `<p class="text-gray-400">No classes scheduled for ${today} in the defined schedule range.</p>`;
                document.getElementById('emailModal').style.display = 'flex';
                return;
            }

            // Fetch the specific document for today's week
            const appIdForFirestore = firebaseConfig.projectId;
            const formattedTodayWeekDate = todayWeekDate.replace(/\//g, '-');
            
            const weeksCollectionRef = collection(db, 'schedules', appIdForFirestore, 'weeks'); // Updated path
            const q = query(weeksCollectionRef); // Fetch all documents in the 'weeks' collection

            try {
                const querySnapshot = await getDocs(q);
                let fetchedWeeklyData = {};
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Reconstruct the scheduleState for the current view from individual documents
                    if (!fetchedWeeklyData[data.category]) fetchedWeeklyData[data.category] = {};
                    if (!fetchedWeeklyData[data.category][data.day]) fetchedWeeklyData[data.category][data.day] = {};
                    if (!fetchedWeeklyData[data.category][data.day][data.className]) {
                        fetchedWeeklyData[data.category][data.day][data.className] = { weeklyAssignments: {} };
                    }
                    fetchedWeeklyData[data.category][data.day][data.className].weeklyAssignments[data.date] = {
                        pros: data.pros || [],
                        availablePros: data.availablePros || [],
                        court: data.court || null
                    };
                });
                scheduleState = fetchedWeeklyData; // Update the global scheduleState

                const assignedProsToday = {}; // { proName: [{className, time, court}, ...] }

                todayDayClasses.forEach(classItem => {
                    const classWeekState = scheduleState[todayCategory]?.[classItem.name]?.weeklyAssignments?.[todayWeekDate];
                    const assignedProsForClass = classWeekState?.pros || [];
                    const courtInfo = classWeekState?.court || 'N/A';

                    assignedProsForClass.forEach(proName => {
                        if (!assignedProsToday[proName]) {
                            assignedProsToday[proName] = [];
                        }
                        assignedProsToday[proName].push({
                            className: classItem.name,
                            time: classItem.time,
                            court: courtInfo
                        });
                    });
                });

                if (Object.keys(assignedProsToday).length === 0) {
                    emailContentArea.innerHTML = `<p class="text-gray-400">No pros assigned for classes today, ${todayWeekDate} (${today}).</p>`;
                } else {
                    for (const proName in assignedProsToday) {
                        const proClasses = assignedProsToday[proName];
                        const proEmail = PRO_AVAILABILITY_DATA.find(p => p.name === proName)?.email || 'N/A';

                        let emailBody = `Hi ${proName},\n\nHere is your schedule for today, ${todayWeekDate} (${today}):\n\n`;
                        proClasses.forEach(assignment => {
                            emailBody += `- ${assignment.className} at ${assignment.time} on Court ${assignment.court}\n`;
                        });
                        emailBody += `\nThank you!`;

                        const emailSubject = `Your Schedule for ${todayWeekDate} (${today})`;

                        const emailHtml = `
                            <div class="bg-gray-700 p-4 rounded-lg shadow-md border border-gray-600 mb-4">
                                <h4 class="text-xl font-semibold text-white mb-2">${proName}'s Schedule</h4>
                                <p class="text-gray-300 mb-2"><strong>To:</strong> ${proEmail}</p>
                                <p class="text-gray-300 mb-2"><strong>Subject:</strong> ${emailSubject}</p>
                                <div class="bg-gray-800 p-3 rounded-md text-gray-200 whitespace-pre-wrap font-mono text-sm">
                                    ${emailBody}
                                </div>
                                <button class="copy-email-btn mt-3 px-4 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700 transition-colors"
                                        data-email-content="${encodeURIComponent(`Subject: ${emailSubject}\n\n${emailBody}`)}">
                                    Copy Email Content
                                </button>
                            </div>
                        `;
                        emailContentArea.insertAdjacentHTML('beforeend', emailHtml);
                    }
                }

                // Attach copy event listeners
                document.querySelectorAll('.copy-email-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const content = decodeURIComponent(e.target.dataset.emailContent);
                        navigator.clipboard.writeText(content).then(() => {
                            e.target.textContent = 'Copied!';
                            setTimeout(() => {
                                e.target.textContent = 'Copy Email Content';
                            }, 2000);
                        }).catch(err => {
                            console.error('Failed to copy text: ', err);
                            alert('Failed to copy. Please copy manually.');
                        });
                    });
                });

                document.getElementById('emailModal').style.display = 'flex'; // Show modal

            } catch (err) {
                console.error("Error generating today's schedule:", err);
                emailContentArea.innerHTML = `<div class="text-red-400">Failed to load today's schedule data. Please check your connection.</div>`;
                document.getElementById('emailModal').style.display = 'flex';
            }
        };


        window.onload = async () => {
            document.getElementById('loading').style.display = 'none';

            // Week navigation buttons
            document.getElementById('prevWeekBtn').addEventListener('click', () => {
                if (currentWeekIndex > 0) {
                    currentWeekIndex--;
                    fetchAndRenderCurrentWeek(); // Fetch and render for the new week
                }
            });
            document.getElementById('nextWeekBtn').addEventListener('click', () => {
                if (ALL_DATES_BY_DAY[currentDay] && currentWeekIndex < ALL_DATES_BY_DAY[currentDay].length - 1) {
                    currentWeekIndex++;
                    fetchAndRenderCurrentWeek(); // Fetch and render for the new week
                }
            });

            // Event listener for the "Show Today's Schedule" button
            document.getElementById('showTodayBtn').addEventListener('click', () => {
                showTodayScheduleEmail();
            });

            // Close modal button functionality
            document.querySelector('#emailModal .close-button').addEventListener('click', () => {
                document.getElementById('emailModal').style.display = 'none';
            });

            // Close modal if clicked outside content
            window.addEventListener('click', (event) => {
                const emailModal = document.getElementById('emailModal');
                if (event.target === emailModal) {
                    emailModal.style.display = 'none';
                }
            });

            try {
                const firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                auth = getAuth(firebaseApp);

                document.getElementById('userId').innerText = 'Authenticating...';

                // We will use a direct fetch for the initial check to avoid onSnapshot's continuous triggering
                // during the initial data population.
                const appIdForFirestore = firebaseConfig.projectId;
                const weeksCollectionRef = collection(db, 'schedules', appIdForFirestore, 'weeks'); 

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        document.getElementById('userId').innerText = user.uid;
                    } else {
                        await signInAnonymously(auth);
                        currentUserId = auth.currentUser.uid;
                        document.getElementById('userId').innerText = currentUserId;
                    }

                    if (db && currentUserId) {
                        // Check if the 'weeks' collection is empty. If so, initialize all documents.
                        const weeksSnapshot = await getDocs(query(weeksCollectionRef));
                        if (weeksSnapshot.empty) {
                            console.log("Firestore 'weeks' collection is empty. Initializing all weekly schedule documents.");
                            await initializeAndSaveAllWeeklySchedules();
                        } else {
                            console.log("Firestore 'weeks' collection already exists. Skipping initial write.");
                        }
                        
                        // Set initial category and day, then fetch and render the current week
                        currentCategory = Object.keys(SCHEDULE_CATEGORIES)[0];
                        currentDay = Object.keys(SCHEDULE_CATEGORIES[currentCategory])[0];
                        renderCategoryTabs();
                        renderDayTabs();
                        await fetchAndRenderCurrentWeek(); // Initial fetch and render
                    }
                });
            } catch (e) {
                console.error("Application failed to initialize:", e);
                const container = document.getElementById('schedule-container');
                container.innerHTML = `<div class="text-red-400">Application failed to initialize. Please check the console for errors.</div>`;
            }
        };
    </script>
</body>
</html>
