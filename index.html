<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tennis Pro Scheduler</title>
    <!-- Tailwind CSS for a clean, modern look -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal {
            display: none;
        }
        .modal.open {
            display: flex;
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your Firebase project configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBMA3OjbUnX2c786WxFtDdWs7jzTfDFUqE",
            authDomain: "master-ntc-scheduler.firebaseapp.com",
            projectId: "master-ntc-scheduler",
            storageBucket: "master-ntc-scheduler.firebasestorage.app",
            messagingSenderId: "756847124761",
            appId: "1:756847124761:web:4d77e91da2cf31b385a588",
            measurementId: "G-CXP60P9M3Q"
        };
        
        // Use projectId as appId for a more reliable identifier outside of Canvas
        const appId = firebaseConfig.projectId;

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId = null;
        let processedScheduleData = [];

        // Hardcoded default pro ratings
        const proRatingsDefault = JSON.stringify([
            { "name": "Nouri", "ratings": ["RED", "ORANGE", "GREEN", "Intro/Novice"] },
            { "name": "John", "ratings": ["Junior Development", "Intro/Novice", "Rally/Bronze", "Silver/Gold", "Wheelchair"] },
            { "name": "Justyna", "ratings": ["RED", "ORANGE", "GREEN", "Junior Development", "High Performance", "Intro/Novice", "Rally/Bronze", "Silver/Gold", "All FT", "Wheelchair"] },
            { "name": "Osas", "ratings": ["ORANGE", "GREEN", "Junior Development", "High Performance", "Intro/Novice", "Rally/Bronze", "Silver/Gold", "All FT", "Seniors", "Fitness"] },
            { "name": "David", "ratings": ["ORANGE", "GREEN", "Junior Development", "High Performance", "Intro/Novice", "Rally/Bronze", "Silver/Gold", "All FT", "Seniors", "Fitness"] },
            { "name": "Karla", "ratings": ["ORANGE", "GREEN", "Junior Development", "High Performance", "Intro/Novice", "Rally/Bronze", "Silver/Gold", "All FT"] },
            { "name": "Danny", "ratings": ["ORANGE", "Junior Development", "High Performance", "All FT", "PACES**"] },
            { "name": "Zack", "ratings": ["ORANGE", "GREEN", "Junior Development", "High Performance", "Intro/Novice", "Rally/Bronze", "Silver/Gold", "All FT"] },
            { "name": "Steven", "ratings": ["ORANGE", "GREEN", "Junior Development", "High Performance", "Intro/Novice", "Rally/Bronze", "Silver/Gold", "All FT"] },
            { "name": "Gus", "ratings": ["ORANGE", "GREEN", "Junior Development", "High Performance", "Intro/Novice", "Rally/Bronze", "Silver/Gold", "PACES**"] },
            { "name": "Alex H. (Assist)", "ratings": ["ORANGE", "GREEN", "Junior Development", "High Performance", "Intro/Novice", "Rally/Bronze", "Silver/Gold"] },
            { "name": "Omer", "ratings": ["ORANGE", "GREEN", "Junior Development", "High Performance", "Intro/Novice", "Rally/Bronze", "Silver/Gold"] },
            { "name": "Anders", "ratings": ["ORANGE", "GREEN", "Junior Development", "High Performance", "Intro/Novice", "Wheelchair", "Seniors"] },
            { "name": "Peter", "ratings": ["ORANGE", "GREEN", "Junior Development", "High Performance", "Intro/Novice", "PACES**", "Wheelchair", "Seniors"] },
            { "name": "Farhad", "ratings": ["ORANGE", "GREEN", "Junior Development", "High Performance", "Intro/Novice", "Rally/Bronze", "Silver/Gold"] },
            { "name": "Jinny", "ratings": ["ORANGE", "GREEN", "Junior Development", "High Performance", "Intro/Novice", "Rally/Bronze", "Silver/Gold", "All FT"] },
            { "name": "Viola (Assist)", "ratings": ["ORANGE", "GREEN", "Junior Development", "High Performance", "Rally/Bronze"] },
            { "name": "Daniel C.", "ratings": ["ORANGE", "GREEN", "Junior Development", "High Performance", "Rally/Bronze", "Silver/Gold"] },
            { "name": "Shaquille", "ratings": ["ORANGE", "GREEN", "Junior Development", "High Performance", "Rally/Bronze", "Silver/Gold"] },
            { "name": "Will (Assist)", "ratings": ["ORANGE", "GREEN", "Junior Development", "High Performance", "Rally/Bronze", "Silver/Gold"] },
            { "name": "Robert", "ratings": ["Junior Development", "High Performance", "Silver/Gold"] },
            { "name": "Felix", "ratings": ["ORANGE", "GREEN", "Junior Development", "High Performance", "Rally/Bronze", "Silver/Gold", "All FT"] },
            { "name": "Petra (Assist)", "ratings": ["ORANGE", "GREEN", "Junior Development", "High Performance"] },
            { "name": "Rohan", "ratings": ["Junior Development", "High Performance", "Rally/Bronze", "Silver/Gold"] },
            { "name": "Orlando", "ratings": ["Junior Development", "High Performance", "Rally/Bronze", "Silver/Gold", "All FT"] }
        ], null, 2);

        // Hardcoded default pro availability from the CSV. This data is now updated to reflect the schedule better.
        const proAvailabilityDefault = JSON.stringify([
            { "name": "John", "availability": [{ "time": "Available" }] },
            { "name": "Rod", "availability": [{ "time": "Available" }] },
            { "name": "Justyna", "availability": [{ "time": "Available" }] },
            { "name": "David", "availability": [{ "time": "4:00P-9:30P" }] },
            { "name": "Leo", "availability": [{ "time": "11:30A-3:30P" }] },
            { "name": "Shaquille", "availability": [{ "time": "8:30A-3:00P" }] },
            { "name": "Valery", "availability": [{ "time": "9:00A-4:00P" }] },
            { "name": "Mellanie", "availability": [{ "time": "9:00A-4:00P" }] },
            { "name": "Daniel C.", "availability": [{ "time": "Available" }] },
            { "name": "Robert", "availability": [{ "time": "Available" }] },
            { "name": "Felix", "availability": [{ "time": "Available" }] },
            { "name": "Orlando", "availability": [{ "time": "Available" }] },
            { "name": "Rohan", "availability": [{ "time": "Available" }] },
            { "name": "Zack", "availability": [{ "time": "Available" }] },
            { "name": "Gus", "availability": [{ "time": "Available" }] },
            { "name": "Steven", "availability": [{ "time": "Available" }] },
            { "name": "Farhad", "availability": [{ "time": "Available" }] }
        ], null, 2);

        // Parse default data immediately
        let proRatings = JSON.parse(proRatingsDefault);
        let proAvailability = JSON.parse(proAvailabilityDefault);

        // Helper function to find class rating from class name
        function findRatingByClass(className) {
            className = className.toLowerCase();
            if (className.includes('red aces') || className.includes('red champs') || className.includes('mam')) return 'RED';
            if (className.includes('orange aces') || className.includes('orange champs') || className.includes('red stars')) return 'ORANGE';
            if (className.includes('green aces') || className.includes('green champs') || className.includes('orange stars') || className.includes('green stars')) return 'GREEN';
            if (className.includes('jd aces plus') || className.includes('jd champs') || className.includes('jd aces') || className.includes('jd stars')) return 'Junior Development';
            if (className.includes('elite') || className.includes('ftf')) return 'High Performance';
            if (className.includes('rally')) return 'Rally/Bronze';
            if (className.includes('silver')) return 'Silver/Gold';
            if (className.includes('gold')) return 'Silver/Gold';
            if (className.includes('novice') || className.includes('intro to tennis')) return 'Intro/Novice';
            
            return 'None';
        }

        // Hardcoded schedule data from the PDF for Monday
        const schedule = [
            { court: 1, name: 'Round Robin', time: '10:00A-11:30A', rating: 'None', pro: null },
            { court: 1, name: 'Round Robin', time: '11:30A-1:00P', rating: 'None', pro: null },
            { court: 1, name: 'FTF', time: '4:00P-6:00P', rating: 'None', pro: null },
            { court: 1, name: 'Intro To Tennis', time: '6:00P-7:30P', rating: findRatingByClass('Intro To Tennis'), pro: null },
            { court: 1, name: 'Night Lights', time: '7:30P-9:00P', rating: 'Gold', pro: null },
            { court: 2, name: 'Round Robin', time: '10:00A-11:30A', rating: 'None', pro: null },
            { court: 2, name: 'Round Robin', time: '11:30A-1:00P', rating: 'None', pro: null },
            { court: 2, name: 'FTF', time: '4:00P-6:00P', rating: 'None', pro: null },
            { court: 2, name: 'Drill & Play', time: '6:00P-8:00P', rating: 'Bronze', pro: null },
            { court: 2, name: 'Zone', time: '8:00P-9:30P', rating: 'None', pro: null },
            { court: 3, name: 'Round Robin', time: '10:00A-11:30A', rating: 'None', pro: null },
            { court: 3, name: 'Round Robin', time: '11:30A-1:00P', rating: 'None', pro: null },
            { court: 3, name: 'Elite', time: '4:00P-6:00P', rating: 'High Performance', pro: null },
            { court: 3, name: 'Drill & Play', time: '6:00P-8:00P', rating: 'Bronze', pro: null },
            { court: 3, name: 'Zone', time: '8:00P-9:30P', rating: 'None', pro: null },
            { court: 4, name: 'Round Robin', time: '10:00A-11:30A', rating: 'None', pro: null },
            { court: 4, name: 'Round Robin', time: '11:30A-1:00P', rating: 'None', pro: null },
            { court: 4, name: 'Elite', time: '4:00P-6:00P', rating: 'High Performance', pro: null },
            { court: 4, name: 'JD Stars', time: '6:30P-8:00P', rating: findRatingByClass('JD Stars'), pro: null },
            { court: 4, name: 'NTC Silver', time: '8:00P-9:30P', rating: 'Silver/Gold', pro: null },
            { court: 5, name: 'Round Robin', time: '10:00A-11:30A', rating: 'None', pro: null },
            { court: 5, name: 'Round Robin', time: '11:30A-1:00P', rating: 'None', pro: null },
            { court: 5, name: 'JR Stroke Series', time: '5:00P-6:00P', rating: 'None', pro: null },
            { court: 5, name: 'Green Champs', time: '6:00P-8:00P', rating: findRatingByClass('Green Champs'), pro: null },
            { court: 5, name: 'NTC Bronze', time: '8:00P-9:30P', rating: 'Rally/Bronze', pro: null },
            { court: 6, name: 'Round Robin', time: '10:00A-11:30A', rating: 'None', pro: null },
            { court: 6, name: 'Round Robin', time: '11:30A-1:00P', rating: 'None', pro: null },
            { court: 6, name: 'JR Stroke Series', time: '5:00P-6:00P', rating: 'None', pro: null },
            { court: 6, name: 'Green Champs', time: '6:00P-8:00P', rating: findRatingByClass('Green Champs'), pro: null },
            { court: 6, name: 'NTC Bronze', time: '8:00P-9:30P', rating: 'Rally/Bronze', pro: null },
            { court: 7, name: 'Novice 102', time: '9:00A-10:30A', rating: findRatingByClass('Novice 102'), pro: null },
            { court: 7, name: 'Lead Pro', time: '10:30A-12:00P', rating: 'Bronze', pro: null },
            { court: 7, name: 'Advanced Zone', time: '12:00P-1:30P', rating: 'None', pro: null },
            { court: 7, name: 'Red Aces', time: '4:00P-5:30P', rating: findRatingByClass('Red Aces'), pro: null },
            { court: 7, name: 'Orange Champs', time: '5:30P-7:00P', rating: findRatingByClass('Orange Champs'), pro: null },
            { court: 7, name: 'NTC Rally', time: '7:00P-8:30P', rating: 'Rally/Bronze', pro: null },
            { court: 7, name: 'Intro to Tennis', time: '8:30P-10:00P', rating: findRatingByClass('Intro to Tennis'), pro: null },
            { court: 8, name: 'NTC Rally', time: '9:00A-10:30A', rating: 'Rally/Bronze', pro: null },
            { court: 8, name: 'Lead Pro', time: '10:30A-12:00P', rating: 'Bronze', pro: null },
            { court: 8, name: 'Orange Aces', time: '4:00P-5:30P', rating: findRatingByClass('Orange Aces'), pro: null },
            { court: 8, name: 'Green Aces', time: '5:30P-7:00P', rating: findRatingByClass('Green Aces'), pro: null },
            { court: 8, name: 'NTC Rally', time: '7:00P-8:30P', rating: 'Rally/Bronze', pro: null },
            { court: 8, name: 'Stroke Series', time: '8:30P-9:30P', rating: 'None', pro: null },
            { court: 9, name: 'NTC Rally', time: '9:00A-10:30A', rating: 'Rally/Bronze', pro: null },
            { court: 9, name: 'Eval', time: '5:00P-5:30P', rating: 'None', pro: null },
            { court: 9, name: 'Jr expansion', time: '5:30P-7:00P', rating: 'None', pro: null },
            { court: 9, name: 'NTC Rally', time: '7:00P-8:30P', rating: 'Rally/Bronze', pro: null },
            { court: 9, name: 'Stroke Series', time: '8:30P-9:30P', rating: 'None', pro: null },
            { court: 10, name: 'Drill & Play', time: '10:00A-11:30A', rating: 'Silver/Gold', pro: null },
            { court: 10, name: 'Green Stars', time: '5:00P-7:00P', rating: findRatingByClass('Green Stars'), pro: null },
            { court: 10, name: 'Novice 102', time: '7:00P-8:30P', rating: findRatingByClass('Novice 102'), pro: null },
            { court: 11, name: 'Drill & Play', time: '10:00A-11:30A', rating: 'Silver/Gold', pro: null },
            { court: 11, name: 'Novice 102', time: '7:00P-8:30P', rating: findRatingByClass('Novice 102'), pro: null },
            { court: 12, name: 'NTC Gold', time: '7:00P-8:30P', rating: 'Silver/Gold', pro: null },
        ];

        // Helper to parse time strings
        function parseTime(timeStr) {
            const [start, end] = timeStr.split('-').map(s => s.trim());
            const startMatch = start.match(/(\d+):?(\d+)?(a|p|am|pm)/i);
            const endMatch = end.match(/(\d+):?(\d+)?(a|p|am|pm)/i);

            if (!startMatch || !endMatch) {
                console.error("Failed to parse time string:", timeStr);
                return null;
            }

            let startHour = parseInt(startMatch[1]);
            let startMinutes = startMatch[2] ? parseInt(startMatch[2]) : 0;
            let startPeriod = startMatch[3] ? startMatch[3].toLowerCase() : '';

            let endHour = parseInt(endMatch[1]);
            let endMinutes = endMatch[2] ? parseInt(endMatch[2]) : 0;
            let endPeriod = endMatch[3] ? endMatch[3].toLowerCase() : '';
            
            // Handle am/pm conversions
            if (startPeriod.includes('p') && startHour < 12) startHour += 12;
            if (startPeriod.includes('a') && startHour === 12) startHour = 0;
            if (endPeriod.includes('p') && endHour < 12) endHour += 12;
            if (endPeriod.includes('a') && endHour === 12) endHour = 0;

            return {
                start: startHour + startMinutes / 60,
                end: endHour + endMinutes / 60
            };
        }

        // Assign a pro and save to database
        async function assignPro(classInfo, proName) {
            const updatedClass = { ...classInfo, pro: proName };
            const docId = `${classInfo.court}-${classInfo.name}-${classInfo.time}`;

            const docRef = doc(db, `artifacts/${appId}/public/data/classAssignments`, docId);
            try {
                await setDoc(docRef, updatedClass, { merge: true });
                setMessage(`Successfully assigned ${proName} to class on court ${classInfo.court}.`, false);
            } catch (error) {
                console.error("Error saving assignment:", error);
                setMessage("Failed to save assignment. Check the console.", true);
            }
        }
        
        // Find eligible pros for a given class
        function findEligiblePros(classInfo) {
            const classTime = parseTime(classInfo.time);
            const classRating = findRatingByClass(classInfo.name) || classInfo.rating;

            if (!classTime) return [];

            const assignedProNames = processedScheduleData.map(c => c.pro).filter(Boolean);
            const availablePros = proAvailability.filter(pro => {
                if (assignedProNames.includes(pro.name)) {
                    return false;
                }
                const availableSlot = pro.availability.find(slot => {
                    if (slot.time.toLowerCase().includes('available')) return true;
                    if (slot.time.toLowerCase().includes('off') || slot.time.toLowerCase().includes('not available')) return false;
                    const slotTime = parseTime(slot.time);
                    if (!slotTime) return false;
                    return (classTime.start >= slotTime.start && classTime.end <= slotTime.end);
                });
                return availableSlot;
            });
            
            const eligiblePros = availablePros.filter(pro => {
                const hasRequiredRating = proRatings.find(proRating =>
                    proRating.name === pro.name && proRating.ratings.includes(classRating)
                );
                return hasRequiredRating;
            });

            return eligiblePros.map(pro => pro.name);
        }
        
        // Function to update the DOM with the schedule
        function renderSchedule() {
            const scheduleBody = document.getElementById('schedule-body');
            scheduleBody.innerHTML = ''; // Clear existing rows

            schedule.forEach((item, index) => {
                const assigned = processedScheduleData.find(assignment => 
                    assignment.court === item.court && assignment.name === item.name && assignment.time === item.time
                );
                const assignedProName = assigned ? assigned.pro : 'N/A';
                
                const currentRating = findRatingByClass(item.name) || item.rating;

                let ratingColor = '';
                if (currentRating.includes('Gold') || currentRating === 'Silver/Gold') ratingColor = 'bg-yellow-500 text-gray-900';
                else if (currentRating.includes('Silver')) ratingColor = 'bg-gray-400 text-gray-900';
                else if (currentRating.includes('Bronze') || currentRating === 'Rally/Bronze') ratingColor = 'bg-orange-400 text-gray-900';
                else if (currentRating.includes('RED')) ratingColor = 'bg-red-600 text-white';
                else if (currentRating.includes('ORANGE')) ratingColor = 'bg-orange-500 text-white';
                else if (currentRating.includes('GREEN')) ratingColor = 'bg-green-500 text-white';
                else ratingColor = 'bg-gray-500 text-gray-100';

                let proColor = assignedProName === 'No Pro Available' ? 'text-red-400' : 'text-green-400';

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-700 transition-colors';
                
                let proDropdownHtml = `<td class="py-4 px-4 whitespace-nowrap"><select class="w-full p-2 bg-gray-700 text-gray-200 rounded-lg" onchange="handleProAssignment(this, ${index})">`;
                proDropdownHtml += `<option value="N/A">Unassigned</option>`;

                const eligiblePros = findEligiblePros(item);
                eligiblePros.forEach(proName => {
                    const isSelected = proName === assignedProName;
                    proDropdownHtml += `<option value="${proName}" ${isSelected ? 'selected' : ''}>${proName}</option>`;
                });
                proDropdownHtml += `</select></td>`;

                row.innerHTML = `
                    <td class="py-4 px-4 whitespace-nowrap text-gray-300">${item.court}</td>
                    <td class="py-4 px-4 whitespace-nowrap text-gray-200">${item.name}</td>
                    <td class="py-4 px-4 whitespace-nowrap text-gray-300">${item.time}</td>
                    <td class="py-4 px-4 whitespace-nowrap">
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${ratingColor}">
                            ${currentRating || 'N/A'}
                        </span>
                    </td>
                    ${proDropdownHtml}
                `;
                scheduleBody.appendChild(row);
            });
        }
        
        // Helper function for user feedback
        function setMessage(text, isError = false) {
            const messageElement = document.getElementById('message');
            messageElement.textContent = text;
            messageElement.className = `mt-2 p-2 rounded-md ${isError ? 'bg-red-600' : 'bg-green-600'} text-white`;
        }

        window.handleProAssignment = async function(selectElement, index) {
            const proName = selectElement.value;
            const classInfo = schedule[index];
            const updatedClass = { ...classInfo, pro: proName };
            const docId = `${classInfo.court}-${classInfo.name}-${classInfo.time}`;

            const docRef = doc(db, `artifacts/${appId}/public/data/classAssignments`, docId);
            try {
                await setDoc(docRef, updatedClass, { merge: true });
                setMessage(`Successfully assigned ${proName} to class on court ${classInfo.court}.`, false);
            } catch (error) {
                console.error("Error saving assignment:", error);
                setMessage("Failed to save assignment. Check the console.", true);
            }
        };

        // Load data from Firestore on app load
        window.onload = function() {
            // Set up Firebase auth and Firestore listener
            onAuthStateChanged(auth, async (user) => {
                const loadingMessage = document.getElementById('loading-message');
                const userIdContainer = document.getElementById('user-id-container');
                
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id').textContent = userId;
                    loadingMessage.style.display = 'none';
                    userIdContainer.classList.remove('hidden');

                    const publicCollectionPath = `artifacts/${appId}/public/data/classAssignments`;
                    const q = collection(db, publicCollectionPath);
                    onSnapshot(q, (querySnapshot) => {
                        const assignedClasses = [];
                        querySnapshot.forEach((doc) => {
                            assignedClasses.push(doc.data());
                        });
                        processedScheduleData = assignedClasses;
                        renderSchedule();
                    }, (error) => {
                        console.error("Error fetching documents:", error);
                        setMessage('Failed to load public data. Check console.', true);
                    });
                } else {
                    await signInAnonymously(auth);
                }
            });
        };
    </script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen font-sans p-6 md:p-12">
    <div class="max-w-7xl mx-auto">
        <header class="mb-8 md:mb-12 text-center">
            <h1 class="text-4xl md:text-5xl font-extrabold text-blue-400 mb-2">Tennis Pro Scheduler</h1>
            <p class="text-gray-400">Manage your class schedule and assign pros based on availability and skill.</p>
        </header>

        <div class="mb-8 text-center text-sm md:text-base">
            <p id="loading-message" class="text-blue-300">Loading...</p>
            <p class="text-gray-400 hidden" id="user-id-container">
                <span class="font-semibold text-blue-300">Your User ID:</span> <span id="user-id"></span>
            </p>
            <p id="message" class="mt-2"></p>
        </div>

        <section>
            <h2 class="text-2xl font-bold mb-6 text-blue-400 text-center">Monday's Class Schedule</h2>
            <div class="bg-gray-800 rounded-xl shadow-lg p-6 overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead>
                        <tr class="text-gray-400 text-left text-sm uppercase tracking-wider">
                            <th class="py-3 px-4">Court</th>
                            <th class="py-3 px-4">Class Name</th>
                            <th class="py-3 px-4">Time</th>
                            <th class="py-3 px-4">Rating</th>
                            <th class="py-3 px-4">Assigned Pro</th>
                        </tr>
                    </thead>
                    <tbody id="schedule-body" class="bg-gray-800 divide-y divide-gray-700">
                        <!-- Table rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>
</body>
</html>
